export const metadata = {
  title: 'CI/CD é›†æˆ',
  description: 'å°† PCU é›†æˆåˆ°æ‚¨çš„æŒç»­é›†æˆå’Œéƒ¨ç½²æµæ°´çº¿ä¸­ï¼Œå®ç°è‡ªåŠ¨åŒ–ä¾èµ–ç®¡ç†ã€‚',
};

# CI/CD é›†æˆ

å°† PCU é›†æˆåˆ°æ‚¨çš„æŒç»­é›†æˆå’Œéƒ¨ç½²æµæ°´çº¿ä¸­ã€‚PCU å¯ä»¥æ— ç¼é›†æˆåˆ°ç°æœ‰çš„ CI/CD å·¥ä½œæµä¸­ï¼Œæ”¯æŒGitHub Actionsã€GitLab CIã€Jenkinsã€Azure DevOpsç­‰å¹³å°ã€‚{{ className: 'lead' }}

## GitHub Actions é›†æˆ

### åŸºç¡€ä¾èµ–æ£€æŸ¥å·¥ä½œæµ

<CodeGroup>

```yaml {{ title: 'åŸºç¡€ä¾èµ–æ£€æŸ¥' }}
name: PCU Dependency Check
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  check-dependencies:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: å®‰è£… PCU
        run: pnpm add -g pnpm-catalog-updates

      - name: æ£€æŸ¥æ›´æ–°
        run: pcu -c --format table

      - name: å®‰å…¨æ‰«æ
        run: pcu security --severity high
```

```yaml {{ title: 'é«˜çº§æ›´æ–°å·¥ä½œæµ' }}
name: PCU é«˜çº§å·¥ä½œæµ

on:
  schedule:
    - cron: '0 8 * * MON' # æ¯å‘¨ä¸€ä¸Šåˆ8ç‚¹
  workflow_dispatch:
    inputs:
      update_target:
        description: 'æ›´æ–°ç›®æ ‡'
        required: false
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - latest

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: pnpm/action-setup@v2
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: å®‰è£…ä¾èµ–
        run: pnpm install

      - name: å®‰è£… PCU
        run: pnpm add -g pnpm-catalog-updates

      - name: é…ç½® Git
        run: |
          git config user.name "PCU Bot"
          git config user.email "pcu-bot@github-actions.com"

      - name: æ£€æŸ¥æ›´æ–°
        id: check-updates
        run: |
          pcu -c --format json > updates.json
          if [ -s updates.json ]; then
            echo "updates-available=true" >> $GITHUB_OUTPUT
          else
            echo "updates-available=false" >> $GITHUB_OUTPUT
          fi

      - name: å®‰å…¨æ‰«æ
        if: steps.check-updates.outputs.updates-available == 'true'
        run: |
          pcu security --format json --severity critical > security.json
          if [ -s security.json ] && [ "$(cat security.json | jq length)" -gt 0 ]; then
            echo "âŒ å‘ç°ä¸¥é‡å®‰å…¨æ¼æ´"
            exit 1
          fi

      - name: æ›´æ–°ä¾èµ–
        if: steps.check-updates.outputs.updates-available == 'true'
        run: |
          pcu -u --target ${{ github.event.inputs.update_target || 'minor' }} --create-backup

      - name: è¿è¡Œæµ‹è¯•
        if: steps.check-updates.outputs.updates-available == 'true'
        run: pnpm test

      - name: åˆ›å»ºæ‹‰å–è¯·æ±‚
        if: steps.check-updates.outputs.updates-available == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: æ›´æ–°ç›®å½•ä¾èµ–'
          title: "ğŸ”„ æ¯å‘¨ä¾èµ–æ›´æ–° (${{ github.event.inputs.update_target || 'minor' }})"
          body: |
            ## ğŸ“¦ ä¾èµ–æ›´æ–°

            æ­¤PRåŒ…å«ç”±PCUç”Ÿæˆçš„ç›®å½•ä¾èµ–æ›´æ–°ã€‚

            ### å˜æ›´å†…å®¹
            - ç›®æ ‡ï¼š`${{ github.event.inputs.update_target || 'minor' }}`
            - å®‰å…¨æ‰«æï¼šâœ… é€šè¿‡
            - æµ‹è¯•ï¼šâœ… é€šè¿‡

            ### å®¡æŸ¥æ¸…å•
            - [ ] æ£€æŸ¥ç ´åæ€§å˜æ›´
            - [ ] æµ‹è¯•å…³é”®ç”¨æˆ·è·¯å¾„
            - [ ] å¦‚éœ€è¦è¯·æ›´æ–°æ–‡æ¡£

            ---
            *ç”±PCUæœºå™¨äººç”Ÿæˆ ğŸ¤–*
          branch: pcu/weekly-updates
          labels: |
            dependencies
            automated
```

</CodeGroup>

## GitLab CI é›†æˆ

GitLab CIæµæ°´çº¿ç”¨äºPCUä¾èµ–ç®¡ç†ï¼š

<CodeGroup>

```yaml {{ title: '.gitlab-ci.yml' }}
stages:
  - check
  - security
  - update

variables:
  PNPM_CACHE_FOLDER: .pnpm-store

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store

before_script:
  - corepack enable
  - pnpm config set store-dir $PNPM_CACHE_FOLDER
  - pnpm install
  - pnpm add -g pnpm-catalog-updates

dependency-check:
  stage: check
  script:
    - pcu -c --format table
    - pcu workspace --validate
  artifacts:
    reports:
      junit: dependency-report.xml
  only:
    - merge_requests
    - main

security-scan:
  stage: security
  script:
    - pcu security --format json --severity moderate > security.json
    - |
      if [ -s security.json ] && [ "$(cat security.json | jq length)" -gt 0 ]; then
        echo "å‘ç°å®‰å…¨æ¼æ´ï¼š"
        cat security.json | jq '.'
        exit 1
      fi
  artifacts:
    reports:
      security: security.json
  only:
    - merge_requests
    - main

weekly-update:
  stage: update
  script:
    - git config user.name "PCU Bot"
    - git config user.email "pcu@gitlab.com"
    - pcu -c --format json > updates.json
    - |
      if [ -s updates.json ]; then
        pcu -u --target minor --create-backup
        git add .
        git commit -m "chore: æ¯å‘¨ä¾èµ–æ›´æ–°"
        git push origin HEAD:pcu/weekly-updates
      fi
  only:
    - schedules
  variables:
    GIT_STRATEGY: clone
```

</CodeGroup>

## Jenkins Pipeline é›†æˆ

ä¼ä¸šçº§ä¾èµ–ç®¡ç†çš„Jenkinsæµæ°´çº¿ï¼š

<CodeGroup>

```groovy {{ title: 'Jenkinsfile' }}
pipeline {
    agent any

    tools {
        nodejs '18'
    }

    environment {
        PNPM_HOME = "${env.WORKSPACE}/.pnpm"
        PATH = "${env.PNPM_HOME}:${env.PATH}"
    }

    stages {
        stage('è®¾ç½®ç¯å¢ƒ') {
            steps {
                sh 'corepack enable'
                sh 'pnpm install'
                sh 'pnpm add -g pnpm-catalog-updates'
            }
        }

        stage('ä¾èµ–æ£€æŸ¥') {
            steps {
                sh 'pcu -c --format json > dependency-check.json'

                script {
                    def updates = readJSON file: 'dependency-check.json'
                    if (updates.size() > 0) {
                        env.HAS_UPDATES = 'true'
                        echo "å‘ç° ${updates.size()} ä¸ªåŒ…éœ€è¦æ›´æ–°"
                    } else {
                        env.HAS_UPDATES = 'false'
                        echo "æ²¡æœ‰å¯ç”¨æ›´æ–°"
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'dependency-check.json'
                }
            }
        }

        stage('å®‰å…¨æ‰«æ') {
            when {
                environment name: 'HAS_UPDATES', value: 'true'
            }
            steps {
                sh 'pcu security --format json --severity high > security-report.json'

                script {
                    def securityReport = readJSON file: 'security-report.json'
                    if (securityReport.vulnerabilities && securityReport.vulnerabilities.size() > 0) {
                        error "å‘ç°ä¸¥é‡å®‰å…¨æ¼æ´ï¼š${securityReport.vulnerabilities.size()}"
                    }
                }
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'security-report.json',
                        reportName: 'Security Report'
                    ])
                }
            }
        }

        stage('æ›´æ–°ä¾èµ–') {
            when {
                allOf {
                    environment name: 'HAS_UPDATES', value: 'true'
                    branch 'main'
                }
            }
            steps {
                sh 'pcu -u --target minor --create-backup'
                sh 'pnpm test'

                script {
                    sh '''
                        git config user.name "Jenkins PCU"
                        git config user.email "jenkins@company.com"
                        git add .
                        git commit -m "chore: è‡ªåŠ¨ä¾èµ–æ›´æ–° [skip ci]"
                    '''

                    // åˆ›å»ºåˆå¹¶è¯·æ±‚ï¼ˆGitLabï¼‰æˆ–æ‹‰å–è¯·æ±‚ï¼ˆGitHubï¼‰
                    sh '''
                        git push origin HEAD:pcu/automated-updates-${BUILD_NUMBER}
                    '''
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }

        success {
            echo 'PCUä¾èµ–æ£€æŸ¥æˆåŠŸå®Œæˆ'
        }

        failure {
            emailext (
                subject: "PCUä¾èµ–æ£€æŸ¥å¤±è´¥ - ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "ä¾èµ–æ£€æŸ¥å¤±è´¥ã€‚è¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡ºã€‚",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
    }
}
```

</CodeGroup>

## Azure DevOps Pipeline

Azure DevOpsæµæ°´çº¿ç”¨äºPCUé›†æˆï¼š

<CodeGroup>

```yaml {{ title: 'azure-pipelines.yml' }}
trigger:
  branches:
    include:
      - main
      - develop

schedules:
  - cron: '0 8 * * 1'
    displayName: æ¯å‘¨ä¾èµ–æ£€æŸ¥
    branches:
      include:
        - main
    always: true

pool:
  vmImage: 'ubuntu-latest'

variables:
  PNPM_CACHE_FOLDER: $(Pipeline.Workspace)/.pnpm-store

stages:
  - stage: DependencyCheck
    displayName: 'ä¾èµ–æ£€æŸ¥'
    jobs:
      - job: CheckUpdates
        displayName: 'æ£€æŸ¥æ›´æ–°'
        steps:
          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              restoreKeys: |
                pnpm | "$(Agent.OS)"
              path: $(PNPM_CACHE_FOLDER)
            displayName: ç¼“å­˜pnpm

          - script: |
              corepack enable
              pnpm config set store-dir $(PNPM_CACHE_FOLDER)
              pnpm install
              pnpm add -g pnpm-catalog-updates
            displayName: 'è®¾ç½®PNPMå’ŒPCU'

          - script: |
              pcu -c --format json > $(Agent.TempDirectory)/updates.json
              pcu workspace --validate
            displayName: 'æ£€æŸ¥ä¾èµ–'

          - script: |
              pcu security --format json --severity moderate > $(Agent.TempDirectory)/security.json
            displayName: 'å®‰å…¨æ‰«æ'

          - task: PublishTestResults@2
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/*-results.xml'
              failTaskOnFailedTests: true
            displayName: 'å‘å¸ƒå®‰å…¨ç»“æœ'

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Agent.TempDirectory)'
              artifactName: 'dependency-reports'
            displayName: 'å‘å¸ƒæ„ä»¶'

  - stage: UpdateDependencies
    displayName: 'æ›´æ–°ä¾èµ–'
    condition: and(succeeded(), or(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.Reason'], 'Manual')))
    jobs:
      - job: UpdateCatalog
        displayName: 'æ›´æ–°ç›®å½•ä¾èµ–'
        steps:
          - checkout: self
            persistCredentials: true

          - script: |
              corepack enable
              pnpm install
              pnpm add -g pnpm-catalog-updates
            displayName: 'è®¾ç½®ç¯å¢ƒ'

          - script: |
              pcu -u --target minor --create-backup
              pnpm test
            displayName: 'æ›´æ–°å¹¶æµ‹è¯•'

          - script: |
              git config user.name "Azure DevOps PCU"
              git config user.email "azuredevops@company.com"
              git add .
              git commit -m "chore: Azure DevOpsè‡ªåŠ¨ä¾èµ–æ›´æ–°"
              git push origin HEAD:refs/heads/pcu/azure-updates-$(Build.BuildNumber)
            displayName: 'æäº¤æ›´æ”¹'
```

</CodeGroup>

## é€šç”¨CI/CDæœ€ä½³å®è·µ

### ç¯å¢ƒå˜é‡é…ç½®

åœ¨æ‰€æœ‰CI/CDå¹³å°ä¸­é…ç½®è¿™äº›ç¯å¢ƒå˜é‡ä»¥ä¼˜åŒ–PCUè¡Œä¸ºï¼š

```bash
# æ ¸å¿ƒé…ç½®
PCU_NO_COLOR=true              # ç¦ç”¨å½©è‰²è¾“å‡º
PCU_CHECK_UPDATES=false        # åœ¨CIä¸­ç¦ç”¨PCUæ›´æ–°æ£€æŸ¥
PCU_VERBOSE=true               # å¯ç”¨è¯¦ç»†æ—¥å¿—
PCU_OUTPUT_FORMAT=json         # ä½¿ç”¨JSONè¾“å‡ºä¾¿äºè§£æ

# ç¼“å­˜é…ç½®
PCU_CACHE_ENABLED=true         # å¯ç”¨ç¼“å­˜ä»¥æé«˜æ€§èƒ½
PCU_CACHE_TTL=1800000         # 30åˆ†é’Ÿç¼“å­˜TTL

# å®‰å…¨é…ç½®
PCU_SECURITY_SEVERITY=high     # æ£€æŸ¥é«˜ä¸¥é‡ç¨‹åº¦æ¼æ´
PCU_AUTO_FIX=false            # åœ¨CIä¸­æ‰‹åŠ¨æ§åˆ¶ä¿®å¤

# æ€§èƒ½é…ç½®
PCU_TIMEOUT=120000            # 2åˆ†é’Ÿè¶…æ—¶
PCU_RETRIES=3                 # ç½‘ç»œè¯·æ±‚é‡è¯•æ¬¡æ•°
PCU_CONCURRENCY=5             # å¹¶å‘è¯·æ±‚é™åˆ¶
```

### å®‰å…¨è€ƒè™‘

#### è®¿é—®ä»¤ç‰Œç®¡ç†

ç¡®ä¿åœ¨CI/CDç¯å¢ƒä¸­å®‰å…¨ç®¡ç†è®¿é—®ä»¤ç‰Œï¼š

```yaml
# GitHub Actions
- name: é…ç½®Git
  run: |
    git config user.name "PCU Bot"
    git config user.email "bot@company.com"
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# GitLab CI
script:
  - git remote set-url origin https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
```

#### åˆ†æ”¯ä¿æŠ¤ç­–ç•¥

é…ç½®åˆ†æ”¯ä¿æŠ¤ä»¥é˜²æ­¢ç›´æ¥æ¨é€åˆ°ä¸»åˆ†æ”¯ï¼š

- è¦æ±‚æ‹‰å–è¯·æ±‚å®¡æŸ¥
- è¦æ±‚çŠ¶æ€æ£€æŸ¥é€šè¿‡
- é™åˆ¶æ¨é€åˆ°å—ä¿æŠ¤åˆ†æ”¯
- è¦æ±‚ç­¾åæäº¤

### æ•…éšœæ’é™¤

#### å¸¸è§CI/CDé—®é¢˜

**æƒé™é”™è¯¯**

```bash
# ä¿®å¤npmæƒé™é—®é¢˜
npm config set prefix ~/.npm-global
export PATH=~/.npm-global/bin:$PATH

# æˆ–ä½¿ç”¨pnpmï¼ˆæ¨èï¼‰
pnpm add -g pnpm-catalog-updates
```

**ç¼“å­˜é—®é¢˜**

```bash
# æ¸…é™¤CIç¼“å­˜
rm -rf node_modules pnpm-lock.yaml
pnpm install

# æ¸…é™¤PCUç¼“å­˜
PCU_CACHE_ENABLED=false pcu check
```

**ç½‘ç»œè¶…æ—¶**

```bash
# å¢åŠ è¶…æ—¶æ—¶é—´
PCU_TIMEOUT=300000 pcu check

# å‡å°‘å¹¶å‘è¯·æ±‚
PCU_CONCURRENCY=2 pcu update
```

### ç›‘æ§å’ŒæŠ¥å‘Š

#### åˆ›å»ºä»ªè¡¨æ¿

ä½¿ç”¨CI/CDå¹³å°çš„åŸç”ŸåŠŸèƒ½åˆ›å»ºä¾èµ–ç®¡ç†ä»ªè¡¨æ¿ï¼š

- **GitHub Actions**: ä½¿ç”¨Action insightså’Œä¾èµ–å›¾
- **GitLab CI**: åˆ©ç”¨Security Dashboardå’Œä¾èµ–æ‰«æ
- **Jenkins**: é…ç½®HTML Publisheræ’ä»¶
- **Azure DevOps**: ä½¿ç”¨Dashboardså’ŒAnalytics

#### é€šçŸ¥é…ç½®

è®¾ç½®é€‚å½“çš„é€šçŸ¥ä»¥ä¿æŒå›¢é˜ŸçŸ¥æƒ…ï¼š

```yaml
# Slacké€šçŸ¥ç¤ºä¾‹ï¼ˆGitHub Actionsï¼‰
- name: Slacké€šçŸ¥
  if: failure()
  uses: 8398a7/action-slack@v3
  with:
    status: failure
    text: PCUä¾èµ–æ£€æŸ¥å¤±è´¥
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

## Dockeré›†æˆ

### å®¹å™¨åŒ–PCUå·¥ä½œæµ

<CodeGroup>

```dockerfile {{ title: 'Dockerfile.pcu' }}
FROM node:18-alpine

# å®‰è£…pnpmå’ŒPCU
RUN corepack enable
RUN pnpm add -g pnpm-catalog-updates

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /workspace

# å¤åˆ¶packageæ–‡ä»¶
COPY package.json pnpm-lock.yaml ./
COPY pnpm-workspace.yaml .pcurc.json ./

# å®‰è£…ä¾èµ–
RUN pnpm install --frozen-lockfile

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PCU_NO_COLOR=true
ENV PCU_VERBOSE=true

# é»˜è®¤å‘½ä»¤
CMD ["pcu", "--help"]
```

```yaml {{ title: 'docker-compose.yml' }}
version: '3.8'

services:
  pcu-check:
    build:
      context: .
      dockerfile: Dockerfile.pcu
    volumes:
      - .:/workspace
      - pnpm-cache:/workspace/.pnpm-store
    environment:
      - PCU_CACHE_ENABLED=true
      - PCU_OUTPUT_FORMAT=json
    command: pcu check --format table

  pcu-security:
    build:
      context: .
      dockerfile: Dockerfile.pcu
    volumes:
      - .:/workspace
    command: pcu security --severity high

volumes:
  pnpm-cache:
```

</CodeGroup>

è¿™äº›CI/CDé›†æˆç¤ºä¾‹æä¾›äº†å…¨é¢çš„è‡ªåŠ¨åŒ–ä¾èµ–ç®¡ç†è§£å†³æ–¹æ¡ˆï¼Œç¡®ä¿æ‚¨çš„é¡¹ç›®å§‹ç»ˆä¿æŒæœ€æ–°å’Œå®‰å…¨çš„ä¾èµ–ã€‚
