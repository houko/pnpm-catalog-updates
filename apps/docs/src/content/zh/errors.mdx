export const metadata = {
  title: '故障排除',
  description:
    '使用 pnpm-catalog-updates 时的常见问题和解决方案。错误消息、调试技巧和故障排除指南。',
};

# 故障排除

常见问题和解决方案，帮助您解决 PCU 的问题。查找常见错误的答案和调试技巧。{{ className: 'lead' }}

## 常见错误

### 未找到工作空间

**错误消息：**

```
Error: No pnpm workspace found in the current directory
```

**原因：** PCU 无法找到 `pnpm-workspace.yaml` 文件或检测到有效的 pnpm 工作空间结构。

**解决方案：**

<CodeGroup>

```bash {{ title: '初始化工作空间' }}
# 创建新的 pnpm 工作空间
pcu init

# 或手动创建 pnpm-workspace.yaml
echo "packages:
  - 'packages/*'" > pnpm-workspace.yaml
```

```bash {{ title: '指定工作空间路径' }}
# 从工作空间根目录运行 PCU
cd /path/to/workspace/root
pcu -c

# 或指定工作空间目录
pcu -c --workspace /path/to/workspace
```

</CodeGroup>

---

### 无目录依赖

**错误消息：**

```
No catalog dependencies found in workspace
```

**原因：** 您的工作空间未使用 pnpm 目录依赖。

**解决方案：**

<CodeGroup>

```yaml {{ title: '向 pnpm-workspace.yaml 添加目录' }}
packages:
  - 'packages/*'

catalog:
  react: ^18.2.0
  typescript: ^5.0.0
  lodash: ^4.17.21
```

```json {{ title: '在 package.json 中使用目录' }}
{
  "name": "my-package",
  "dependencies": {
    "react": "catalog:",
    "typescript": "catalog:",
    "lodash": "catalog:"
  }
}
```

</CodeGroup>

---

### 注册表访问问题

**错误消息：**

```
Error: getaddrinfo ENOTFOUND registry.npmjs.org
```

**原因：** 网络连接问题或注册表访问问题。

**解决方案：**

<CodeGroup>

```bash {{ title: '网络故障排除' }}
# 检查网络连接
ping registry.npmjs.org

# 使用增加的超时测试
pcu -c --timeout 60000

# 减少并发请求
pcu -c --concurrency 2
```

```ini {{ title: '配置注册表 (.npmrc)' }}
# 使用不同注册表
registry=https://registry.npmjs.org/

# 企业网络
registry=https://your-corporate-registry.com/
strict-ssl=false
```

</CodeGroup>

---

### 身份验证错误

**错误消息：**

```
Error: 401 Unauthorized - authentication required
```

**原因：** 私有注册表缺少或无效的身份验证令牌。

**解决方案：**

<CodeGroup>

```ini {{ title: '配置身份验证 (.npmrc)' }}
@myorg:registry=https://npm.private-registry.com/
//npm.private-registry.com/:_authToken=${NPM_TOKEN}

# 或使用传统身份验证
//npm.private-registry.com/:username=myuser
//npm.private-registry.com/:_password=base64password
//npm.private-registry.com/:email=my.email@example.com
```

```bash {{ title: '设置环境变量' }}
export NPM_TOKEN=your_token_here
pcu -c
```

</CodeGroup>

---

### 配置文件错误

**错误消息：**

```
Error: Invalid configuration in .pcurc.json
```

**原因：** JSON 格式错误或无效配置选项。

**解决方案：**

<CodeGroup>

```bash {{ title: '验证配置' }}
# 检查 JSON 语法
node -e "console.log(JSON.parse(require('fs').readFileSync('.pcurc.json', 'utf8')))"

# 重新生成配置
mv .pcurc.json .pcurc.json.backup
pcu init --force
```

```json {{ title: '最小有效配置' }}
{
  "defaults": {
    "target": "latest"
  },
  "output": {
    "format": "table"
  }
}
```

</CodeGroup>

## 调试

### 启用详细日志

<CodeGroup>

```bash {{ title: '详细输出' }}
# 启用详细日志
pcu -c --verbose

# 使用环境变量调试模式
DEBUG=pcu:* pcu -c

# 特定调试模块
DEBUG=pcu:core,pcu:registry pcu -c
```

```bash {{ title: '输出到文件' }}
# 保存调试输出
pcu -c --verbose > debug.log 2>&1

# 检查日志文件
cat debug.log | grep -i error
```

</CodeGroup>

### 工作空间验证

<CodeGroup>

```bash {{ title: '验证工作空间' }}
# 检查工作空间配置
pcu -s --validate

# 获取详细工作空间信息
pcu -s --stats --verbose
```

```bash {{ title: '手动验证' }}
# 检查 pnpm-workspace.yaml 是否存在
ls -la pnpm-workspace.yaml

# 验证目录语法
pnpm exec -- pnpm list --depth=0
```

</CodeGroup>

## 性能问题

### 网络请求缓慢

**症状：** PCU 检查更新需要很长时间

**解决方案：**

<CodeGroup>

```json {{ title: '优化配置' }}
{
  "advanced": {
    "concurrency": 3,
    "timeout": 30000,
    "retries": 2,
    "cacheValidityMinutes": 120
  }
}
```

```bash {{ title: '缓存管理' }}
# 如果缓存过时则清除
rm -rf ~/.pcu/cache

# 禁用缓存用于调试
pcu -c --no-cache
```

</CodeGroup>

### 高内存使用

**症状：** PCU 在大型工作空间中消耗过多内存

**解决方案：**

<CodeGroup>

```json {{ title: '内存优化' }}
{
  "advanced": {
    "concurrency": 2,
    "batchSize": 10
  }
}
```

```bash {{ title: '进程管理' }}
# 监控内存使用
top -p $(pgrep node)

# 使用 Node.js 内存标志
node --max-old-space-size=4096 $(which pcu) -c
```

</CodeGroup>

## 环境问题

### Node.js 版本兼容性

**错误消息：**

```
Error: Unsupported Node.js version
```

**解决方案：**

<CodeGroup>

```bash {{ title: '检查版本' }}
node --version  # 应该是 >= 18.0.0

# 安装兼容版本
nvm install 20
nvm use 20
```

```bash {{ title: '更新 Node.js' }}
# 使用 nvm
nvm install --lts
nvm use --lts

# 验证安装
node --version
npm --version
```

</CodeGroup>

### pnpm 版本问题

**错误消息：**

```
Error: pnpm command not found
```

**解决方案：**

<CodeGroup>

```bash {{ title: '安装 pnpm' }}
# 安装最新 pnpm
npm install -g pnpm@latest

# 验证安装
pnpm --version  # 应该是 >= 8.0.0
```

```bash {{ title: '替代安装' }}
# 使用 Corepack（推荐）
corepack enable
corepack prepare pnpm@latest --activate

# 直接下载
curl -fsSL https://get.pnpm.io/install.sh | sh -
```

</CodeGroup>

## Windows 特定问题

### 路径分隔符问题

**错误消息：**

```
Error: Cannot resolve workspace path
```

**解决方案：**

<CodeGroup>

```bash {{ title: '使用正斜杠' }}
# 在路径中使用正斜杠
pcu -c --workspace ./my/workspace

# 或使用 PowerShell
pwsh -c "pcu -c"
```

```json {{ title: 'Windows 配置' }}
{
  "workspace": {
    "pathSeparator": "/"
  }
}
```

</CodeGroup>

### 权限错误

**错误消息：**

```
Error: EPERM: operation not permitted
```

**解决方案：**

<CodeGroup>

```cmd {{ title: '以管理员身份运行' }}
# 以管理员身份运行命令提示符
runas /user:Administrator cmd

# 或以管理员身份使用 PowerShell
Start-Process powershell -Verb RunAs
```

```bash {{ title: '修复权限' }}
# 修复 npm 权限
npm config set cache ~/.npm-cache
npm config set prefix ~/npm-global
```

</CodeGroup>

## 获取帮助

### 诊断信息

报告问题时，请包含此诊断信息：

<CodeGroup>

```bash {{ title: '系统信息' }}
# PCU 版本
pcu --version

# Node.js 和 pnpm 版本
node --version
pnpm --version

# 操作系统
uname -a  # Linux/macOS
systeminfo  # Windows
```

```bash {{ title: '配置信息' }}
# 显示当前配置
cat .pcurc.json

# 工作空间验证
pcu -s --validate --verbose

# 调试输出
DEBUG=pcu:* pcu -c --verbose
```

</CodeGroup>

### 支持渠道

- 🐛 **错误报告**：[GitHub Issues](https://github.com/houko/pnpm-catalog-updates/issues)
- 💬 **问题**：[GitHub Discussions](https://github.com/houko/pnpm-catalog-updates/discussions)
- 📖 **文档**：查看此文档获取详细指南
- 🔧 **功能请求**：使用带增强标签的 GitHub Issues

### 问题模板

报告错误时，请包含：

1. **PCU 版本**和**使用的命令**
2. **错误消息**（带 `--verbose` 的完整输出）
3. **环境**（操作系统、Node.js、pnpm 版本）
4. **工作空间结构**（pnpm-workspace.yaml、package.json）
5. **配置**（.pcurc.json、.npmrc 如果相关）
6. **重现问题的步骤**
7. **预期与实际行为**
