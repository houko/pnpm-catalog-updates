export const metadata = {
  title: 'Exemples',
  description:
    "Exemples concrets et cas d'usage pour pnpm-catalog-updates. Apprenez √† partir de sc√©narios pratiques et de flux de travail courants.",
};

# Exemples

Exemples concrets et cas d'usage pour vous aider √† tirer le meilleur parti de PCU. Des mises √† jour simples √† la gestion complexe de monorepo. {{ className: 'lead' }}

## Flux de travail de base

### V√©rification quotidienne des d√©pendances

V√©rifiez les mises √† jour dans le cadre de votre routine quotidienne de d√©veloppement :

<CodeGroup>

```bash {{ title: 'V√©rification rapide' }}
# V√©rifier les mises √† jour avec sortie simple
pcu -c --format minimal

# Exemple de sortie :
# react           ^18.2.0  ‚Üí  ^18.3.0
# typescript      ^5.0.0   ‚Üí  ^5.2.0
# @types/node     ^18.0.0  ‚Üí  ^20.0.0
```

```bash {{ title: 'V√©rification d√©taill√©e' }}
# V√©rifier avec format de tableau complet
pcu -c

# Affiche un tableau color√© avec :
# - Noms des packages
# - Versions actuelles
# - Versions disponibles
# - Types de mise √† jour (major/minor/patch)
# - Indicateurs de s√©curit√©
```

</CodeGroup>

### Mises √† jour s√©curis√©es avec sauvegarde

Mettez √† jour les d√©pendances en toute s√©curit√© avec des sauvegardes automatiques :

```bash
# Mises √† jour interactives avec sauvegarde
pcu -i -b

# Ou mises √† jour mineures automatis√©es avec sauvegarde
pcu -u --target minor --create-backup
```

### Mises √† jour cibl√©es sp√©cifiques

Mettre √† jour uniquement des types sp√©cifiques de changements :

<CodeGroup>

```bash {{ title: 'Mises √† jour conservatrices' }}
# Uniquement les mises √† jour de correctifs (corrections de bugs)
pcu -u --target patch

# Uniquement les mises √† jour mineures (nouvelles fonctionnalit√©s, pas de changements cassants)
pcu -u --target minor
```

```bash {{ title: 'Tout √† jour' }}
# Mettre √† jour vers les derni√®res versions (y compris major)
pcu -u --target latest

# Inclure les versions pr√©liminaires
pcu -u --prerelease
```

</CodeGroup>

## Espaces de travail multi-catalogues

### Sc√©nario de support h√©rit√©

Gestion de plusieurs versions React dans un espace de travail :

<CodeGroup>

```yaml {{ title: 'pnpm-workspace.yaml' }}
packages:
  - "apps/*"
  - "packages/*"

catalog:
  # Catalogue par d√©faut - derni√®res versions
  react: ^18.2.0
  react-dom: ^18.2.0
  @types/react: ^18.2.0

catalogs:
  # Support h√©rit√©
  react17:
    react: ^17.0.2
    react-dom: ^17.0.2
    @types/react: ^17.0.62

  # Tests b√™ta
  react-next:
    react: ^19.0.0-beta
    react-dom: ^19.0.0-beta
```

```bash {{ title: 'Mises √† jour sp√©cifiques au catalogue' }}
# Mettre √† jour uniquement le catalogue par d√©faut
pcu -u --catalog default

# Mettre √† jour les versions React h√©rit√©es
pcu -u --catalog react17 --target minor

# V√©rifier les versions b√™ta
pcu -c --catalog react-next --prerelease
```

</CodeGroup>

### Utilisation de package

```json {{ title: 'package.json' }}
{
  "name": "@myorg/modern-app",
  "dependencies": {
    "react": "catalog:",
    "react-dom": "catalog:"
  }
}
```

```json {{ title: 'package.json h√©rit√©' }}
{
  "name": "@myorg/legacy-app",
  "dependencies": {
    "react": "catalog:react17",
    "react-dom": "catalog:react17"
  }
}
```

## Exemples de configuration

### Gestion de l'√©cosyst√®me React

Mises √† jour coordonn√©es pour React et les packages li√©s :

```json {{ title: '.pcurc.json' }}
{
  "packageRules": [
    {
      "patterns": ["react", "react-dom"],
      "target": "minor",
      "requireConfirmation": true,
      "relatedPackages": [
        "@types/react",
        "@types/react-dom",
        "react-router-dom",
        "@testing-library/react"
      ]
    }
  ],
  "security": {
    "autoFixVulnerabilities": true,
    "allowMajorForSecurity": true
  }
}
```

### Configuration de projet TypeScript

Mises √† jour conservatrices de TypeScript avec d√©finitions de types automatiques :

```json {{ title: '.pcurc.json' }}
{
  "packageRules": [
    {
      "patterns": ["typescript"],
      "target": "minor",
      "requireConfirmation": true
    },
    {
      "patterns": ["@types/*"],
      "target": "latest",
      "autoUpdate": true
    },
    {
      "patterns": ["eslint*", "@typescript-eslint/*"],
      "target": "minor",
      "groupUpdate": true
    }
  ]
}
```

### Configuration d'entreprise

Configuration pr√™te pour l'entreprise avec contr√¥les stricts :

```json {{ title: '.pcurc.json' }}
{
  "defaults": {
    "target": "minor",
    "createBackup": true
  },
  "exclude": ["typescript", "@types/node", "react", "react-dom"],
  "security": {
    "autoFixVulnerabilities": true,
    "allowMajorForSecurity": true,
    "notifyOnSecurityUpdate": true
  },
  "advanced": {
    "concurrency": 3,
    "timeout": 60000,
    "retries": 5
  },
  "ui": {
    "theme": "minimal",
    "animations": false
  }
}
```

## Int√©gration CI/CD

### GitHub Actions

Automatisez la v√©rification des d√©pendances dans votre pipeline CI :

<CodeGroup>

```yaml {{ title: '.github/workflows/dependencies.yml' }}
name: Check Dependencies

on:
  schedule:
    - cron: '0 9 * * MON'  # Tous les lundis √† 9h
  workflow_dispatch:

jobs:
  check-deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install PCU
        run: npm install -g pcu

      - name: Check for updates
        run: pcu -c --format json > updates.json

      - name: Create Issue if Updates Available
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const updates = JSON.parse(fs.readFileSync('updates.json', 'utf8'));
            if (updates.length > 0) {
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'Dependencies Update Available',
                body: `Found ${updates.length} packages that can be updated:

` +
                      updates.map(u => `- ${u.package}: ${u.current} ‚Üí ${u.available}`).join('
')
              });
            }
```

```bash {{ title: 'Scripts Package.json' }}
# Ajouter √† votre package.json
{
  "scripts": {
    "deps:check": "pcu -c",
    "deps:update": "pcu -i -b",
    "deps:update-minor": "pcu -u --target minor --create-backup",
    "deps:analyze": "pcu -a default"
  }
}
```

</CodeGroup>

## Gestion d'erreurs et d√©pannage

### Probl√®mes r√©seau

G√©rer les probl√®mes r√©seau et l'acc√®s aux registres :

```bash
# Augmenter le d√©lai d'expiration pour les connexions lentes
pcu -c --timeout 60000

# R√©duire la concurrence pour les r√©seaux instables
pcu -u --concurrency 2
```

### Validation de l'espace de travail

Validez la configuration de votre espace de travail :

```bash
# V√©rifier la configuration de l'espace de travail
pcu -s --validate

# Obtenir des informations d√©taill√©es sur l'espace de travail
pcu -s --stats --verbose
```

### Registres priv√©s

PCU lit automatiquement les configurations `.npmrc` et `.pnpmrc` :

<CodeGroup>

```ini {{ title: '.npmrc' }}
@myorg:registry=https://npm.private-registry.com/
//npm.private-registry.com/:_authToken=${NPM_TOKEN}

registry=https://registry.npmjs.org/
```

```bash {{ title: 'Utilisation' }}
# PCU utilisera automatiquement vos param√®tres de registre
pcu -c

# V√©rifier les packages du registre priv√©
pcu -c --include "@myorg/*"
```

</CodeGroup>

## Cas d'usage avanc√©s

### Analyse d'impact

Analyser l'impact de la mise √† jour de packages sp√©cifiques :

```bash
# Analyser l'impact de la mise √† jour React
pcu -a default react

# Analyser avec une version sp√©cifique
pcu -a default react 18.3.0

# V√©rifier l'impact sur tous les catalogues
pcu -a react17 react 17.0.3
```

### Mises √† jour s√©lectives

Mettre √† jour uniquement des packages ou motifs sp√©cifiques :

```bash
# Mettre √† jour uniquement les packages li√©s √† React
pcu -u --include "react*"

# Mettre √† jour tout sauf les frameworks principaux
pcu -u --exclude "react*,vue*,angular*"

# Mettre √† jour uniquement les d√©finitions de types
pcu -u --include "@types/*" --target latest
```

### Analyse d'ex√©cution √† sec

Pr√©visualiser les modifications avant de les appliquer :

```bash
# Voir ce qui serait mis √† jour
pcu -u --dry-run --verbose

# Pr√©visualiser avec des cibles sp√©cifiques
pcu -u --dry-run --target minor --include "@types/*"
```

## Bonnes pratiques

### Flux de travail quotidien

1. **V√©rification matinale** : `pcu -c` pour voir les mises √† jour disponibles
2. **Examiner l'impact** : Utiliser `pcu -a` pour les mises √† jour importantes
3. **Mise √† jour s√©curis√©e** : `pcu -i -b` pour les mises √† jour interactives avec sauvegarde
4. **Tester** : Ex√©cuter votre suite de tests apr√®s les mises √† jour
5. **Commit** : Committer les mises √† jour de d√©pendances s√©par√©ment

### Flux de travail d'√©quipe

1. **Configuration partag√©e** : Committer `.pcurc.json` dans le contr√¥le de version
2. **R√©visions r√©guli√®res** : Planifier des r√©unions hebdomadaires de r√©vision des d√©pendances
3. **Priorit√© s√©curit√©** : Toujours prioriser les mises √† jour de s√©curit√©
4. **Documentation** : Documenter les d√©cisions majeures de d√©pendances
5. **Plan de rollback** : Conserver des sauvegardes pour un rollback facile

### Flux de travail de release

1. **V√©rification pr√©-release** : `pcu -c --target patch` avant les releases
2. **Scan de s√©curit√©** : Activer `autoFixVulnerabilities` en CI
3. **√âpinglage de version** : Utiliser des versions exactes pour les releases de production
4. **Calendrier de mise √† jour** : Planifier les mises √† jour de d√©pendances entre les releases

## Surveillance de s√©curit√©

### Scan de s√©curit√© continu

Int√©grez le scan de s√©curit√© dans votre flux de travail de d√©veloppement :

<CodeGroup>

```bash {{ title: 'V√©rification de s√©curit√© quotidienne' }}
# Scan de s√©curit√© rapide
pcu security

# Correction automatis√©e des vuln√©rabilit√©s
pcu security --fix-vulns

# Se concentrer uniquement sur les probl√®mes √©lev√©s et critiques
pcu security --severity high --fix-vulns
```

```bash {{ title: 'Audit de s√©curit√© complet' }}
# Scan de s√©curit√© complet avec int√©gration Snyk
pcu security --snyk --include-dev --verbose

# Exporter le rapport de s√©curit√© pour r√©vision
pcu security --format json --snyk > security-report.json
```

</CodeGroup>

### CI/CD ax√© sur la s√©curit√©

```yaml {{ title: '.github/workflows/security.yml' }}
name: Security Audit

on:
  schedule:
    - cron: '0 2 * * *' # Quotidien √† 2h
  pull_request:
    branches: [main]

jobs:
  security:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install PCU
        run: npm install -g pcu

      - name: Security Scan
        run: pcu security --fix-vulns --format json > security-results.json

      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: security-results.json
```

## Personnalisation de th√®me

### Configuration interactive de th√®me

Configurez l'apparence de PCU pour votre √©quipe :

```bash
# Lancer l'assistant de th√®me interactif
pcu theme --interactive

# D√©finir un th√®me sp√©cifique
pcu theme --set modern

# Lister tous les th√®mes disponibles avec aper√ßus
pcu theme --list
```

### Configuration de th√®me d'√©quipe

```json {{ title: '.pcurc.json' }}
{
  "ui": {
    "theme": "modern",
    "progressBars": true,
    "animations": true,
    "colorScheme": "auto"
  },
  "output": {
    "format": "table",
    "color": true,
    "verbose": false
  }
}
```

## Optimisation des performances

### Configuration de grand monorepo

Optimisez PCU pour de grands espaces de travail avec des centaines de packages :

```json {{ title: '.pcurc.json' }}
{
  "advanced": {
    "concurrency": 10,
    "timeout": 120000,
    "retries": 3,
    "cacheResults": true,
    "batchSize": 50
  },
  "performance": {
    "skipUnchanged": true,
    "useCache": true,
    "parallelAnalysis": true
  }
}
```

### Traitement s√©lectif

```bash
# Traiter uniquement les packages modifi√©s depuis le dernier commit
pcu -c --changed-only

# Ignorer les packages non modifi√©s depuis 30 jours
pcu -c --skip-stale --stale-days 30

# Traitement parall√®le pour des r√©sultats plus rapides
pcu -c --concurrency 15
```

## Exemples de migration

### Depuis npm-check-updates

Migration de `ncu` vers PCU :

<CodeGroup>

```bash {{ title: '√âquivalent npm-check-updates' }}
# Anciennes commandes ncu ‚Üí Nouveaux √©quivalents PCU

# ncu
pcu -c

# ncu -u
pcu -u

# ncu --target minor
pcu -u --target minor

# ncu --interactive
pcu -i

# ncu --packageFile package.json
pcu -w ./path/to/workspace
```

```json {{ title: 'Configuration de migration' }}
{
  "migration": {
    "from": "npm-check-updates",
    "preserveRanges": true,
    "convertToCatalog": true
  },
  "defaults": {
    "target": "minor",
    "interactive": false
  }
}
```

</CodeGroup>

### Conversion vers les catalogues pnpm

Transformer un espace de travail existant pour utiliser les catalogues pnpm :

```bash
# Analyser les d√©pendances actuelles
pcu workspace --stats

# Initialiser la structure de catalogue
pcu init --create-workspace

# Convertir les d√©pendances vers les r√©f√©rences de catalogue
pcu convert --to-catalog --dry-run
pcu convert --to-catalog --backup
```

---

## Guides de migration

### Migration depuis npm-check-updates

Transition en douceur de `npm-check-updates` vers PCU pour la gestion des catalogues pnpm :

<CodeGroup>

```bash {{ title: 'Avant : npm-check-updates' }}
# Ancien flux de travail avec ncu
ncu --upgrade --packageFile package.json
ncu --upgrade --packageFile packages/*/package.json
npm install
```

```bash {{ title: 'Apr√®s : PCU' }}
# Nouveau flux de travail avec PCU
pcu -c                    # V√©rifier les mises √† jour de catalogue
pcu -i                    # Mises √† jour de catalogue interactives
# pnpm met automatiquement √† jour tous les packages utilisant le catalogue
```

</CodeGroup>

#### √âtapes de migration

1. **Installer PCU aux c√¥t√©s de ncu** temporairement pour comparaison
2. **Initialiser la configuration PCU** :
   ```bash
   pcu init --template standard
   ```
3. **Comparer les sorties** pour s'assurer d'une fonctionnalit√© √©quivalente :
   ```bash
   ncu --format minimal > ncu-output.txt
   pcu -c --format minimal > pcu-output.txt
   diff ncu-output.txt pcu-output.txt
   ```
4. **Migrer les r√®gles de package** de la configuration ncu
5. **Supprimer ncu** une fois √† l'aise avec PCU

### Migration depuis Dependabot

Remplacer Dependabot par PCU pour un contr√¥le plus granulaire :

<CodeGroup>

```yaml {{ title: 'Avant : .github/dependabot.yml' }}
version: 2
updates:
  - package-ecosystem: 'npm'
    directory: '/'
    schedule:
      interval: 'weekly'
    open-pull-requests-limit: 5
```

```yaml {{ title: 'Apr√®s : .github/workflows/pcu-updates.yml' }}
name: PCU Dependency Updates
on:
  schedule:
    - cron: '0 9 * * MON' # Hebdomadaire lundi 9h
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - run: pnpm install
      - run: pnpm add -g pnpm-catalog-updates

      # V√©rifier les mises √† jour
      - name: Check updates
        run: pcu -c --format json > updates.json

      # Cr√©er PR si des mises √† jour sont disponibles
      - name: Create PR
        run: |
          if [ -s updates.json ]; then
            pcu -u --target minor --create-backup
            git add .
            git commit -m "chore: update dependencies via PCU"
            # Utiliser GitHub CLI pour cr√©er la PR
            gh pr create --title "üîÑ Weekly dependency updates" --body "Automated updates via PCU"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

</CodeGroup>

### Migration depuis Renovate

Transition de Renovate vers PCU avec configuration avanc√©e :

#### Diff√©rences cl√©s

| Fonctionnalit√©    | Renovate               | PCU                                 |
| ----------------- | ---------------------- | ----------------------------------- |
| **Port√©e**        | Packages individuels   | Mises √† jour au niveau catalogue    |
| **Configuration** | renovate.json          | .pcurc.json                         |
| **UI**            | Tableau de bord web    | Terminal + int√©gration CI           |
| **Monorepo**      | Configuration complexe | Support d'espace de travail int√©gr√© |

#### Configuration de migration

<CodeGroup>

```json {{ title: 'Avant : renovate.json' }}
{
  "extends": ["config:base"],
  "schedule": ["before 5am on monday"],
  "packageRules": [
    {
      "matchPackageNames": ["react", "react-dom"],
      "groupName": "React"
    }
  ]
}
```

```json {{ title: 'Apr√®s : .pcurc.json' }}
{
  "packageRules": [
    {
      "name": "React ecosystem",
      "patterns": ["react", "react-dom", "@types/react*"],
      "target": "minor",
      "groupUpdate": true,
      "requireConfirmation": true
    }
  ],
  "monorepo": {
    "syncVersions": {
      "enabled": true,
      "groups": [
        {
          "name": "react-ecosystem",
          "packages": ["react", "react-dom", "@types/react"],
          "strategy": "exact"
        }
      ]
    }
  }
}
```

</CodeGroup>

---

## Int√©gration de flux de travail CI/CD

### Int√©gration GitHub Actions

Configuration GitHub Actions compl√®te pour la gestion automatis√©e des d√©pendances :

<CodeGroup>

```yaml {{ title: 'V√©rification de d√©pendance de base' }}
name: Dependency Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  dependency-check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with:
          version: latest
      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install PCU
        run: pnpm add -g pnpm-catalog-updates

      - name: Check for updates
        run: pcu -c --format table

      - name: Security scan
        run: pcu security --severity high
```

```yaml {{ title: 'Flux de travail de mise √† jour avanc√©' }}
name: Advanced PCU Workflow

on:
  schedule:
    - cron: '0 8 * * MON' # Lundi 8h
  workflow_dispatch:
    inputs:
      update_target:
        description: 'Update target'
        required: false
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - latest

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: pnpm/action-setup@v2
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install

      - name: Install PCU
        run: pnpm add -g pnpm-catalog-updates

      - name: Configure Git
        run: |
          git config user.name "PCU Bot"
          git config user.email "pcu-bot@github-actions.com"

      - name: Check for updates
        id: check-updates
        run: |
          pcu -c --format json > updates.json
          if [ -s updates.json ]; then
            echo "updates-available=true" >> $GITHUB_OUTPUT
          else
            echo "updates-available=false" >> $GITHUB_OUTPUT
          fi

      - name: Security scan
        if: steps.check-updates.outputs.updates-available == 'true'
        run: |
          pcu security --format json --severity critical > security.json
          if [ -s security.json ] && [ "$(cat security.json | jq length)" -gt 0 ]; then
            echo "‚ùå Critical security vulnerabilities found"
            exit 1
          fi

      - name: Update dependencies
        if: steps.check-updates.outputs.updates-available == 'true'
        run: |
          pcu -u --target ${{ github.event.inputs.update_target || 'minor' }} --create-backup

      - name: Run tests
        if: steps.check-updates.outputs.updates-available == 'true'
        run: pnpm test

      - name: Create Pull Request
        if: steps.check-updates.outputs.updates-available == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update catalog dependencies'
          title: "üîÑ Weekly dependency updates (${{ github.event.inputs.update_target || 'minor' }})"
          body: |
            ## üì¶ Dependency Updates

            This PR contains catalog dependency updates generated by PCU.

            ### Changes
            - Target: `${{ github.event.inputs.update_target || 'minor' }}`
            - Security scan: ‚úÖ Passed
            - Tests: ‚úÖ Passed

            ### Review Checklist
            - [ ] Review breaking changes
            - [ ] Test critical user paths
            - [ ] Update documentation if needed

            ---
            *Generated by PCU Bot ü§ñ*
          branch: pcu/weekly-updates
          labels: |
            dependencies
            automated
```

</CodeGroup>

### Int√©gration GitLab CI

Pipeline GitLab CI pour la gestion des d√©pendances PCU :

<CodeGroup>

```yaml {{ title: '.gitlab-ci.yml' }}
stages:
  - check
  - security
  - update

variables:
  PNPM_CACHE_FOLDER: .pnpm-store

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store

before_script:
  - corepack enable
  - pnpm config set store-dir $PNPM_CACHE_FOLDER
  - pnpm install
  - pnpm add -g pnpm-catalog-updates

dependency-check:
  stage: check
  script:
    - pcu -c --format table
    - pcu workspace --validate
  artifacts:
    reports:
      junit: dependency-report.xml
  only:
    - merge_requests
    - main

security-scan:
  stage: security
  script:
    - pcu security --format json --severity moderate > security.json
    - |
      if [ -s security.json ] && [ "$(cat security.json | jq length)" -gt 0 ]; then
        echo "Security vulnerabilities found:"
        cat security.json | jq '.'
        exit 1
      fi
  artifacts:
    reports:
      security: security.json
  only:
    - merge_requests
    - main

weekly-update:
  stage: update
  script:
    - git config user.name "PCU Bot"
    - git config user.email "pcu@gitlab.com"
    - pcu -c --format json > updates.json
    - |
      if [ -s updates.json ]; then
        pcu -u --target minor --create-backup
        git add .
        git commit -m "chore: weekly dependency updates"
        git push origin HEAD:pcu/weekly-updates
      fi
  only:
    - schedules
  variables:
    GIT_STRATEGY: clone
```

</CodeGroup>

### Int√©gration de pipeline Jenkins

Pipeline Jenkins pour la gestion des d√©pendances d'entreprise :

<CodeGroup>

```groovy {{ title: 'Jenkinsfile' }}
pipeline {
    agent any

    tools {
        nodejs '18'
    }

    environment {
        PNPM_HOME = "${env.WORKSPACE}/.pnpm"
        PATH = "${env.PNPM_HOME}:${env.PATH}"
    }

    stages {
        stage('Setup') {
            steps {
                sh 'corepack enable'
                sh 'pnpm install'
                sh 'pnpm add -g pnpm-catalog-updates'
            }
        }

        stage('Dependency Check') {
            steps {
                sh 'pcu -c --format json > dependency-check.json'

                script {
                    def updates = readJSON file: 'dependency-check.json'
                    if (updates.size() > 0) {
                        env.HAS_UPDATES = 'true'
                        echo "Found ${updates.size()} packages to update"
                    } else {
                        env.HAS_UPDATES = 'false'
                        echo "No updates available"
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'dependency-check.json'
                }
            }
        }

        stage('Security Scan') {
            when {
                environment name: 'HAS_UPDATES', value: 'true'
            }
            steps {
                sh 'pcu security --format json --severity high > security-report.json'

                script {
                    def securityReport = readJSON file: 'security-report.json'
                    if (securityReport.vulnerabilities && securityReport.vulnerabilities.size() > 0) {
                        error "Critical security vulnerabilities found: ${securityReport.vulnerabilities.size()}"
                    }
                }
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'security-report.json',
                        reportName: 'Security Report'
                    ])
                }
            }
        }

        stage('Update Dependencies') {
            when {
                allOf {
                    environment name: 'HAS_UPDATES', value: 'true'
                    branch 'main'
                }
            }
            steps {
                sh 'pcu -u --target minor --create-backup'
                sh 'pnpm test'

                script {
                    sh '''
                        git config user.name "Jenkins PCU"
                        git config user.email "jenkins@company.com"
                        git add .
                        git commit -m "chore: automated dependency updates [skip ci]"
                    '''

                    // Create merge request (GitLab) or pull request (GitHub)
                    sh '''
                        git push origin HEAD:pcu/automated-updates-${BUILD_NUMBER}
                    '''
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }

        success {
            echo 'PCU dependency check completed successfully'
        }

        failure {
            emailext (
                subject: "PCU Dependency Check Failed - ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "Dependency check failed. Please review the console output.",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
    }
}
```

</CodeGroup>

### Pipeline Azure DevOps

Pipeline Azure DevOps pour l'int√©gration PCU :

<CodeGroup>

```yaml {{ title: 'azure-pipelines.yml' }}
trigger:
  branches:
    include:
      - main
      - develop

schedules:
  - cron: '0 8 * * 1'
    displayName: Weekly dependency check
    branches:
      include:
        - main
    always: true

pool:
  vmImage: 'ubuntu-latest'

variables:
  PNPM_CACHE_FOLDER: $(Pipeline.Workspace)/.pnpm-store

stages:
  - stage: DependencyCheck
    displayName: 'Dependency Check'
    jobs:
      - job: CheckUpdates
        displayName: 'Check for updates'
        steps:
          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              restoreKeys: |
                pnpm | "$(Agent.OS)"
              path: $(PNPM_CACHE_FOLDER)
            displayName: Cache pnpm

          - script: |
              corepack enable
              pnpm config set store-dir $(PNPM_CACHE_FOLDER)
              pnpm install
              pnpm add -g pnpm-catalog-updates
            displayName: 'Setup PNPM and PCU'

          - script: |
              pcu -c --format json > $(Agent.TempDirectory)/updates.json
              pcu workspace --validate
            displayName: 'Check dependencies'

          - script: |
              pcu security --format json --severity moderate > $(Agent.TempDirectory)/security.json
            displayName: 'Security scan'

          - task: PublishTestResults@2
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/*-results.xml'
              failTaskOnFailedTests: true
            displayName: 'Publish security results'

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Agent.TempDirectory)'
              artifactName: 'dependency-reports'
            displayName: 'Publish artifacts'

  - stage: UpdateDependencies
    displayName: 'Update Dependencies'
    condition: and(succeeded(), or(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.Reason'], 'Manual')))
    jobs:
      - job: UpdateCatalog
        displayName: 'Update catalog dependencies'
        steps:
          - checkout: self
            persistCredentials: true

          - script: |
              corepack enable
              pnpm install
              pnpm add -g pnpm-catalog-updates
            displayName: 'Setup environment'

          - script: |
              git config user.name "Azure DevOps PCU"
              git config user.email "devops@company.com"

              pcu -u --target minor --create-backup

              if [ -n "$(git status --porcelain)" ]; then
                git add .
                git commit -m "chore: update catalog dependencies [skip ci]"
                git push origin HEAD:refs/heads/pcu/automated-updates-$(Build.BuildNumber)
              fi
            displayName: 'Update dependencies'

          - script: pnpm test
            displayName: 'Run tests'
```

</CodeGroup>

### Int√©gration Docker

PCU conteneuris√© pour des environnements CI/CD coh√©rents :

<CodeGroup>

```dockerfile {{ title: 'Dockerfile.pcu' }}
FROM node:18-alpine

# Install pnpm and PCU
RUN corepack enable
RUN pnpm add -g pnpm-catalog-updates

# Set working directory
WORKDIR /workspace

# Copy package files
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml .pcurc.json ./

# Install dependencies
RUN pnpm install --frozen-lockfile

# Set entrypoint
ENTRYPOINT ["pcu"]
CMD ["--help"]
```

```yaml {{ title: 'docker-compose.yml' }}
version: '3.8'

services:
  pcu-check:
    build:
      context: .
      dockerfile: Dockerfile.pcu
    volumes:
      - .:/workspace
      - pnpm-store:/workspace/.pnpm-store
    command: ['-c', '--format', 'table']

  pcu-security:
    build:
      context: .
      dockerfile: Dockerfile.pcu
    volumes:
      - .:/workspace
      - pnpm-store:/workspace/.pnpm-store
    command: ['security', '--format', 'json']

  pcu-update:
    build:
      context: .
      dockerfile: Dockerfile.pcu
    volumes:
      - .:/workspace
      - pnpm-store:/workspace/.pnpm-store
    command: ['-u', '--target', 'minor', '--dry-run']

volumes:
  pnpm-store:
```

```bash {{ title: 'Exemples d'utilisation' }}
# Construire le conteneur PCU
docker build -t pcu:latest -f Dockerfile.pcu .

# V√©rifier les mises √† jour
docker run --rm -v $(pwd):/workspace pcu:latest -c

# Mise √† jour interactive
docker run --rm -it -v $(pwd):/workspace pcu:latest -i

# Scan de s√©curit√© en CI
docker-compose run --rm pcu-security > security-report.json
```

</CodeGroup>

---

## Flux de travail d'entreprise

### Gestion multi-environnements

G√©rer les d√©pendances √† travers les environnements de d√©veloppement, staging et production :

<CodeGroup>

```json {{ title: '.pcurc.development.json' }}
{
  "defaults": {
    "target": "latest",
    "createBackup": true,
    "interactive": true
  },
  "ui": {
    "theme": "modern",
    "progressBarStyle": "fancy"
  },
  "packageRules": [
    {
      "patterns": ["*"],
      "target": "latest",
      "requireConfirmation": false
    }
  ]
}
```

```json {{ title: '.pcurc.production.json' }}
{
  "defaults": {
    "target": "patch",
    "createBackup": true,
    "interactive": false
  },
  "ui": {
    "theme": "minimal",
    "progressBarStyle": "minimal"
  },
  "packageRules": [
    {
      "patterns": ["*"],
      "target": "patch",
      "requireConfirmation": true
    }
  ],
  "security": {
    "autoFixVulnerabilities": true,
    "severityThreshold": "high"
  }
}
```

</CodeGroup>

### Flux de travail d'approbation

Impl√©menter des flux de travail d'approbation pour les mises √† jour critiques :

```bash
# Flux de travail de mise √† jour de production
pcu -c --config .pcurc.production.json > updates-pending.json

# G√©n√©rer une demande d'approbation
pcu analyze default typescript --format json > impact-analysis.json

# Apr√®s approbation, appliquer les mises √† jour
pcu -u --config .pcurc.production.json --create-backup

# Rollback si des probl√®mes sont trouv√©s
git checkout HEAD~1 -- package.json pnpm-lock.yaml
pnpm install
```
