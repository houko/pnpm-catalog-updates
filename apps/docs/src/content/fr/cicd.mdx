export const metadata = {
  title: 'Int√©gration CI/CD',
  description:
    "Int√©grez PCU dans vos pipelines d'int√©gration continue et de d√©ploiement pour une gestion automatis√©e des d√©pendances.",
};

# Int√©gration CI/CD

Int√©grez PCU dans vos pipelines d'int√©gration continue et de d√©ploiement. PCU peut s'int√©grer parfaitement aux flux de travail CI/CD existants, prenant en charge GitHub Actions, GitLab CI, Jenkins, Azure DevOps et d'autres plateformes. {{ className: 'lead' }}

## Int√©gration GitHub Actions

### Flux de Travail de V√©rification des D√©pendances de Base

<CodeGroup>

```yaml {{ title: 'V√©rification des D√©pendances de Base' }}
name: PCU Dependency Check
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  check-dependencies:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Installer les d√©pendances
        run: pnpm install

      - name: Installer PCU
        run: pnpm add -g pnpm-catalog-updates

      - name: V√©rifier les mises √† jour
        run: pcu -c --format table

      - name: Scan de s√©curit√©
        run: pcu security --severity high
```

```yaml {{ title: 'Flux de Travail de Mise √† Jour Avanc√©' }}
name: PCU Advanced Workflow

on:
  schedule:
    - cron: '0 8 * * MON' # Lundi 8h du matin
  workflow_dispatch:
    inputs:
      update_target:
        description: 'Cible de mise √† jour'
        required: false
        default: 'minor'
        type: choice
        options:
          - patch
          - minor
          - latest

jobs:
  update-dependencies:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: pnpm/action-setup@v2
        with:
          version: latest

      - uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Installer les d√©pendances
        run: pnpm install

      - name: Installer PCU
        run: pnpm add -g pnpm-catalog-updates

      - name: Configurer Git
        run: |
          git config user.name "PCU Bot"
          git config user.email "pcu-bot@github-actions.com"

      - name: V√©rifier les mises √† jour
        id: check-updates
        run: |
          pcu -c --format json > updates.json
          if [ -s updates.json ]; then
            echo "updates-available=true" >> $GITHUB_OUTPUT
          else
            echo "updates-available=false" >> $GITHUB_OUTPUT
          fi

      - name: Scan de s√©curit√©
        if: steps.check-updates.outputs.updates-available == 'true'
        run: |
          pcu security --format json --severity critical > security.json
          if [ -s security.json ] && [ "$(cat security.json | jq length)" -gt 0 ]; then
            echo "‚ùå Vuln√©rabilit√©s de s√©curit√© critiques trouv√©es"
            exit 1
          fi

      - name: Mettre √† jour les d√©pendances
        if: steps.check-updates.outputs.updates-available == 'true'
        run: |
          pcu -u --target ${{ github.event.inputs.update_target || 'minor' }} --create-backup

      - name: Ex√©cuter les tests
        if: steps.check-updates.outputs.updates-available == 'true'
        run: pnpm test

      - name: Cr√©er une Pull Request
        if: steps.check-updates.outputs.updates-available == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: mise √† jour des d√©pendances du catalogue'
          title: "üîÑ Mises √† jour hebdomadaires des d√©pendances (${{ github.event.inputs.update_target || 'minor' }})"
          body: |
            ## üì¶ Mises √† Jour des D√©pendances

            Cette PR contient les mises √† jour des d√©pendances du catalogue g√©n√©r√©es par PCU.

            ### Changements
            - Cible : `${{ github.event.inputs.update_target || 'minor' }}`
            - Scan de s√©curit√© : ‚úÖ R√©ussi
            - Tests : ‚úÖ R√©ussis

            ### Liste de Contr√¥le de R√©vision
            - [ ] Examiner les changements cassants
            - [ ] Tester les chemins utilisateur critiques
            - [ ] Mettre √† jour la documentation si n√©cessaire

            ---
            *G√©n√©r√© par PCU Bot ü§ñ*
          branch: pcu/weekly-updates
          labels: |
            dependencies
            automated
```

</CodeGroup>

## Int√©gration GitLab CI

Pipeline GitLab CI pour la gestion des d√©pendances PCU :

<CodeGroup>

```yaml {{ title: '.gitlab-ci.yml' }}
stages:
  - check
  - security
  - update

variables:
  PNPM_CACHE_FOLDER: .pnpm-store

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - .pnpm-store

before_script:
  - corepack enable
  - pnpm config set store-dir $PNPM_CACHE_FOLDER
  - pnpm install
  - pnpm add -g pnpm-catalog-updates

dependency-check:
  stage: check
  script:
    - pcu -c --format table
    - pcu workspace --validate
  artifacts:
    reports:
      junit: dependency-report.xml
  only:
    - merge_requests
    - main

security-scan:
  stage: security
  script:
    - pcu security --format json --severity moderate > security.json
    - |
      if [ -s security.json ] && [ "$(cat security.json | jq length)" -gt 0 ]; then
        echo "Vuln√©rabilit√©s de s√©curit√© trouv√©es :"
        cat security.json | jq '.'
        exit 1
      fi
  artifacts:
    reports:
      security: security.json
  only:
    - merge_requests
    - main

weekly-update:
  stage: update
  script:
    - git config user.name "PCU Bot"
    - git config user.email "pcu@gitlab.com"
    - pcu -c --format json > updates.json
    - |
      if [ -s updates.json ]; then
        pcu -u --target minor --create-backup
        git add .
        git commit -m "chore: mises √† jour hebdomadaires des d√©pendances"
        git push origin HEAD:pcu/weekly-updates
      fi
  only:
    - schedules
  variables:
    GIT_STRATEGY: clone
```

</CodeGroup>

## Int√©gration Pipeline Jenkins

Pipeline Jenkins de niveau entreprise pour la gestion des d√©pendances :

<CodeGroup>

```groovy {{ title: 'Jenkinsfile' }}
pipeline {
    agent any

    tools {
        nodejs '18'
    }

    environment {
        PNPM_HOME = "${env.WORKSPACE}/.pnpm"
        PATH = "${env.PNPM_HOME}:${env.PATH}"
    }

    stages {
        stage('Configuration') {
            steps {
                sh 'corepack enable'
                sh 'pnpm install'
                sh 'pnpm add -g pnpm-catalog-updates'
            }
        }

        stage('V√©rification des D√©pendances') {
            steps {
                sh 'pcu -c --format json > dependency-check.json'

                script {
                    def updates = readJSON file: 'dependency-check.json'
                    if (updates.size() > 0) {
                        env.HAS_UPDATES = 'true'
                        echo "Trouv√© ${updates.size()} packages √† mettre √† jour"
                    } else {
                        env.HAS_UPDATES = 'false'
                        echo "Aucune mise √† jour disponible"
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'dependency-check.json'
                }
            }
        }

        stage('Scan de S√©curit√©') {
            when {
                environment name: 'HAS_UPDATES', value: 'true'
            }
            steps {
                sh 'pcu security --format json --severity high > security-report.json'

                script {
                    def securityReport = readJSON file: 'security-report.json'
                    if (securityReport.vulnerabilities && securityReport.vulnerabilities.size() > 0) {
                        error "Vuln√©rabilit√©s de s√©curit√© critiques trouv√©es : ${securityReport.vulnerabilities.size()}"
                    }
                }
            }
            post {
                always {
                    publishHTML([
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        reportDir: '.',
                        reportFiles: 'security-report.json',
                        reportName: 'Security Report'
                    ])
                }
            }
        }

        stage('Mise √† Jour des D√©pendances') {
            when {
                allOf {
                    environment name: 'HAS_UPDATES', value: 'true'
                    branch 'main'
                }
            }
            steps {
                sh 'pcu -u --target minor --create-backup'
                sh 'pnpm test'

                script {
                    sh '''
                        git config user.name "Jenkins PCU"
                        git config user.email "jenkins@company.com"
                        git add .
                        git commit -m "chore: mises √† jour automatis√©es des d√©pendances [skip ci]"
                    '''

                    // Cr√©er une merge request (GitLab) ou pull request (GitHub)
                    sh '''
                        git push origin HEAD:pcu/automated-updates-${BUILD_NUMBER}
                    '''
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }

        success {
            echo 'V√©rification des d√©pendances PCU termin√©e avec succ√®s'
        }

        failure {
            emailext (
                subject: "√âchec de la V√©rification des D√©pendances PCU - ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "La v√©rification des d√©pendances a √©chou√©. Veuillez consulter la sortie console.",
                to: "${env.CHANGE_AUTHOR_EMAIL}"
            )
        }
    }
}
```

</CodeGroup>

## Pipeline Azure DevOps

Pipeline Azure DevOps pour l'int√©gration PCU :

<CodeGroup>

```yaml {{ title: 'azure-pipelines.yml' }}
trigger:
  branches:
    include:
      - main
      - develop

schedules:
  - cron: '0 8 * * 1'
    displayName: V√©rification hebdomadaire des d√©pendances
    branches:
      include:
        - main
    always: true

pool:
  vmImage: 'ubuntu-latest'

variables:
  PNPM_CACHE_FOLDER: $(Pipeline.Workspace)/.pnpm-store

stages:
  - stage: DependencyCheck
    displayName: 'V√©rification des D√©pendances'
    jobs:
      - job: CheckUpdates
        displayName: 'V√©rifier les mises √† jour'
        steps:
          - task: Cache@2
            inputs:
              key: 'pnpm | "$(Agent.OS)" | pnpm-lock.yaml'
              restoreKeys: |
                pnpm | "$(Agent.OS)"
              path: $(PNPM_CACHE_FOLDER)
            displayName: Cache pnpm

          - script: |
              corepack enable
              pnpm config set store-dir $(PNPM_CACHE_FOLDER)
              pnpm install
              pnpm add -g pnpm-catalog-updates
            displayName: 'Configuration PNPM et PCU'

          - script: |
              pcu -c --format json > $(Agent.TempDirectory)/updates.json
              pcu workspace --validate
            displayName: 'V√©rifier les d√©pendances'

          - script: |
              pcu security --format json --severity moderate > $(Agent.TempDirectory)/security.json
            displayName: 'Scan de s√©curit√©'

          - task: PublishTestResults@2
            condition: always()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/*-results.xml'
              failTaskOnFailedTests: true
            displayName: 'Publier les r√©sultats de s√©curit√©'

          - task: PublishBuildArtifacts@1
            inputs:
              pathToPublish: '$(Agent.TempDirectory)'
              artifactName: 'dependency-reports'
            displayName: 'Publier les artefacts'

  - stage: UpdateDependencies
    displayName: 'Mise √† Jour des D√©pendances'
    condition: and(succeeded(), or(eq(variables['Build.Reason'], 'Schedule'), eq(variables['Build.Reason'], 'Manual')))
    jobs:
      - job: UpdateCatalog
        displayName: 'Mettre √† jour les d√©pendances du catalogue'
        steps:
          - checkout: self
            persistCredentials: true

          - script: |
              corepack enable
              pnpm install
              pnpm add -g pnpm-catalog-updates
            displayName: 'Configuration de l\'environnement'

          - script: |
              pcu -u --target minor --create-backup
              pnpm test
            displayName: 'Mettre √† jour et tester'

          - script: |
              git config user.name "Azure DevOps PCU"
              git config user.email "azuredevops@company.com"
              git add .
              git commit -m "chore: mises √† jour automatis√©es des d√©pendances Azure DevOps"
              git push origin HEAD:refs/heads/pcu/azure-updates-$(Build.BuildNumber)
            displayName: 'Valider les changements'
```

</CodeGroup>

## Meilleures Pratiques CI/CD G√©n√©rales

### Configuration des Variables d'Environnement

Configurez ces variables d'environnement sur toutes les plateformes CI/CD pour optimiser le comportement de PCU :

```bash
# Configuration principale
PCU_NO_COLOR=true              # D√©sactiver la sortie color√©e
PCU_CHECK_UPDATES=false        # D√©sactiver les v√©rifications de mise √† jour PCU en CI
PCU_VERBOSE=true               # Activer les logs d√©taill√©s
PCU_OUTPUT_FORMAT=json         # Utiliser la sortie JSON pour un parsing plus facile

# Configuration du cache
PCU_CACHE_ENABLED=true         # Activer le cache pour de meilleures performances
PCU_CACHE_TTL=1800000         # TTL du cache de 30 minutes

# Configuration de s√©curit√©
PCU_SECURITY_SEVERITY=high     # V√©rifier les vuln√©rabilit√©s de haute s√©v√©rit√©
PCU_AUTO_FIX=false            # Contr√¥le manuel des corrections en CI

# Configuration des performances
PCU_TIMEOUT=120000            # Timeout de 2 minutes
PCU_RETRIES=3                 # Nombre de tentatives pour les requ√™tes r√©seau
PCU_CONCURRENCY=5             # Limite de requ√™tes concurrentes
```

### Consid√©rations de S√©curit√©

#### Gestion des Tokens d'Acc√®s

Assurez-vous de la gestion s√©curis√©e des tokens d'acc√®s dans les environnements CI/CD :

```yaml
# GitHub Actions
- name: Configurer Git
  run: |
    git config user.name "PCU Bot"
    git config user.email "bot@company.com"
  env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# GitLab CI
script:
  - git remote set-url origin https://oauth2:${CI_PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
```

#### Strat√©gie de Protection des Branches

Configurez la protection des branches pour emp√™cher les pushes directs vers la branche principale :

- Exiger des r√©visions de pull request
- Exiger que les v√©rifications de statut passent
- Restreindre les pushes vers les branches prot√©g√©es
- Exiger des commits sign√©s

### D√©pannage

#### Probl√®mes CI/CD Courants

**Erreurs de Permissions**

```bash
# Corriger les probl√®mes de permissions npm
npm config set prefix ~/.npm-global
export PATH=~/.npm-global/bin:$PATH

# Ou utiliser pnpm (recommand√©)
pnpm add -g pnpm-catalog-updates
```

**Probl√®mes de Cache**

```bash
# Vider le cache CI
rm -rf node_modules pnpm-lock.yaml
pnpm install

# Vider le cache PCU
PCU_CACHE_ENABLED=false pcu check
```

**Timeouts R√©seau**

```bash
# Augmenter le timeout
PCU_TIMEOUT=300000 pcu check

# R√©duire les requ√™tes concurrentes
PCU_CONCURRENCY=2 pcu update
```

### Monitoring et Rapports

#### Cr√©ation de Tableaux de Bord

Utilisez les fonctionnalit√©s natives des plateformes CI/CD pour cr√©er des tableaux de bord de gestion des d√©pendances :

- **GitHub Actions** : Utilisez les insights d'Actions et les graphiques de d√©pendances
- **GitLab CI** : Exploitez le Security Dashboard et le scan de d√©pendances
- **Jenkins** : Configurez le plugin HTML Publisher
- **Azure DevOps** : Utilisez les Dashboards et Analytics

#### Configuration des Notifications

Configurez des notifications appropri√©es pour tenir les √©quipes inform√©es :

```yaml
# Exemple de notification Slack (GitHub Actions)
- name: Notification Slack
  if: failure()
  uses: 8398a7/action-slack@v3
  with:
    status: failure
    text: √âchec de la v√©rification des d√©pendances PCU
  env:
    SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
```

## Int√©gration Docker

### Flux de Travail PCU Conteneuris√©

<CodeGroup>

```dockerfile {{ title: 'Dockerfile.pcu' }}
FROM node:18-alpine

# Installer pnpm et PCU
RUN corepack enable
RUN pnpm add -g pnpm-catalog-updates

# D√©finir le r√©pertoire de travail
WORKDIR /workspace

# Copier les fichiers de package
COPY package.json pnpm-lock.yaml ./
COPY pnpm-workspace.yaml .pcurc.json ./

# Installer les d√©pendances
RUN pnpm install --frozen-lockfile

# D√©finir les variables d'environnement
ENV PCU_NO_COLOR=true
ENV PCU_VERBOSE=true

# Commande par d√©faut
CMD ["pcu", "--help"]
```

```yaml {{ title: 'docker-compose.yml' }}
version: '3.8'

services:
  pcu-check:
    build:
      context: .
      dockerfile: Dockerfile.pcu
    volumes:
      - .:/workspace
      - pnpm-cache:/workspace/.pnpm-store
    environment:
      - PCU_CACHE_ENABLED=true
      - PCU_OUTPUT_FORMAT=json
    command: pcu check --format table

  pcu-security:
    build:
      context: .
      dockerfile: Dockerfile.pcu
    volumes:
      - .:/workspace
    command: pcu security --severity high

volumes:
  pnpm-cache:
```

</CodeGroup>

Ces exemples d'int√©gration CI/CD fournissent des solutions compl√®tes de gestion automatis√©e des d√©pendances, garantissant que vos projets restent √† jour et s√©curis√©s.
